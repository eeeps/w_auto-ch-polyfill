<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title></title>
<meta name="viewport" content="width=device-width">
<script>

// when <img> elements come into the dom, start observing their size
const ro = new ResizeObserver( ( entries ) => {
	entries.forEach( ( entry ) => {
		// if the image has loaded
		// disconnect and return
		// else
		if ( entry.contentRect.width > 0 ) { // if the <img> has been laid out
		     // and has sizes
		     // and has a cloudinary w_auto:x:y url
		     // replace the sizes, and rewrite the cloudinary url
		     // todo double partial loads still possible?
			console.log( entry.contentRect.width );
			console.log( entry.target.complete );
		}
	} );
} );

const mo = new MutationObserver( ( mutations ) => {
	for ( const mutation of mutations ) {
		for ( const newNode of mutation.addedNodes ) {
			if ( newNode.nodeType === 1 && // elements only, no text!
			     newNode.nodeName === "IMG" ) { // and just IMG elements please
				ro.observe( newNode );
			}
		}
	}
} );

// start MutationObserving the document
mo.observe( document, { childList: true, subtree: true } );

</script>
<style>
img {
	width: 25%;
	height: auto;
}
</style>
</head>
<body>

<img
	src="https://o.img.rodeo/f_auto,q_auto,c_limit,w_auto:300:600/dogs/7"
	sizes="auto"
	loading="lazy"
	width="6000"
	height="4000"
	alt="A dog chasing a ball."
>


</body>
</html>